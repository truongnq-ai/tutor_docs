DB SCHEMA AND FLYWAY PLAN – PHASE 1 (FINAL)
Project: Gia sư Toán AI
Applies to: Phase 1 – Core Personal Learning System
Status: FINAL – FROZEN BEFORE CODING

MỤC TIÊU & PHẠM VI

Tài liệu này là nguồn sự thật duy nhất cho database Phase 1.

Mục tiêu:

Định nghĩa schema DB cho Phase 1

Bảo vệ invariant cốt lõi của domain học tập

Bảo toàn đầy đủ tài sản tri thức (content)

Không vi phạm bất kỳ System Law nào

Phase 1 DB:

KHÔNG Question

KHÔNG Session / MiniTest

KHÔNG Trial / License / Payment

KHÔNG Device / Analytics

KHÔNG Retry / Attempt phức tạp

PHÂN TÁCH DOMAIN TRONG DATABASE

Database Phase 1 gồm 3 nhóm rõ ràng:

Auth & Identity (xác thực, phiên làm việc)

Content Domain (tài sản tri thức, do admin/AI/giáo viên tạo)

Learning Domain (runtime học tập của Student)

Ba nhóm này:

CÙNG NẰM TRONG core-service

NHƯNG TUYỆT ĐỐI KHÔNG LẪN LOGIC

AUTH & IDENTITY TABLES

2.1. users

Purpose:

Định danh người dùng

Phân quyền cơ bản

Columns:

id (UUID, PK)

username (VARCHAR, UNIQUE, NOT NULL)

password_hash (VARCHAR, NOT NULL)

name (VARCHAR, NOT NULL)

role (VARCHAR, NOT NULL)
Allowed values: ADMIN | PARENT | STUDENT

created_at (TIMESTAMP, NOT NULL)

updated_at (TIMESTAMP, NOT NULL)

Constraints:

role CHECK IN ('ADMIN','PARENT','STUDENT')

Notes:

users KHÔNG chứa state học tập

2.2. refresh_token

Purpose:

Duy trì phiên đăng nhập

Phục vụ auth, không ảnh hưởng domain học

Columns:

id (UUID, PK)

user_id (UUID, FK → users.id)

token (VARCHAR, UNIQUE, NOT NULL)

expires_at (TIMESTAMP, NOT NULL)

revoked (BOOLEAN, NOT NULL DEFAULT FALSE)

created_at (TIMESTAMP, NOT NULL)

Notes:

revoke token KHÔNG được ảnh hưởng domain

CONTENT DOMAIN TABLES (ASSET TRI THỨC)

3.1. chapter

Purpose:

Nội dung chương học

Columns:

id (UUID, PK)

code (VARCHAR, UNIQUE, NOT NULL)

name (VARCHAR, NOT NULL)

description (TEXT)

grade (INT, NOT NULL)

created_at (TIMESTAMP, NOT NULL)

updated_at (TIMESTAMP, NOT NULL)

Notes:

Chapter KHÔNG chứa tiến độ học

3.2. skill

Purpose:

Phân loại kỹ năng

Columns:

id (UUID, PK)

code (VARCHAR, UNIQUE, NOT NULL)

name (VARCHAR, NOT NULL)

description (TEXT)

created_at (TIMESTAMP, NOT NULL)

updated_at (TIMESTAMP, NOT NULL)

3.3. exercise

Purpose:

Đề bài toán (content gốc)

Columns:

id (UUID, PK)

chapter_id (UUID, FK → chapter.id)

skill_id (UUID, FK → skill.id)

content_text (TEXT, NOT NULL)

content_latex (TEXT)

difficulty (INT, NOT NULL)

created_by (VARCHAR, NOT NULL)
Allowed values: ADMIN | AI | TEACHER

status (VARCHAR, NOT NULL)
Allowed values: DRAFT | REVIEWED | APPROVED

created_at (TIMESTAMP, NOT NULL)

updated_at (TIMESTAMP, NOT NULL)

Notes:

Exercise KHÔNG chứa lời giải

Exercise KHÔNG gắn Student

3.4. exercise_solution

Purpose:

Lời giải chuẩn cho Exercise

Columns:

id (UUID, PK)

exercise_id (UUID, FK → exercise.id)

solution_steps (TEXT)

final_answer (TEXT)

explanation (TEXT)

created_by (VARCHAR, NOT NULL)

created_at (TIMESTAMP, NOT NULL)

Notes:

Một Exercise có thể có nhiều Solution

Solution là tài sản tri thức, KHÔNG phải runtime

3.5. exercise_tag

Purpose:

Gắn nhãn phân loại cho Exercise

Columns:

id (UUID, PK)

exercise_id (UUID, FK → exercise.id)

tag_name (VARCHAR, NOT NULL)

tag_type (VARCHAR)

created_at (TIMESTAMP, NOT NULL)

Notes:

KHÔNG có bảng Tag master

Tag chỉ tồn tại trong ngữ cảnh Exercise

3.6. exercise_review_log

Purpose:

Audit & review content

Columns:

id (UUID, PK)

exercise_id (UUID, FK → exercise.id)

reviewer_id (UUID, FK → users.id)

action (VARCHAR, NOT NULL)
Allowed values: SUBMITTED | APPROVED | REJECTED | UPDATED

comment (TEXT)

created_at (TIMESTAMP, NOT NULL)

Notes:

ReviewLog KHÔNG ảnh hưởng học sinh

Không tham gia learning flow

LEARNING DOMAIN TABLES (PHASE 1)

4.1. student_profile

Purpose:

Lưu lifecycle học tập

Columns:

user_id (UUID, PK, FK → users.id)

lifecycle_state (VARCHAR, NOT NULL)
Allowed values: ACTIVE | SUSPENDED | INACTIVE

created_at (TIMESTAMP, NOT NULL)

updated_at (TIMESTAMP, NOT NULL)

Notes:

lifecycle_state là nguồn sự thật duy nhất cho quyền học

4.2. parent_student

Purpose:

Quan hệ Parent – Student

Columns:

parent_id (UUID, FK → users.id)

student_id (UUID, FK → users.id)

Primary Key:

(parent_id, student_id)

4.3. chapter_progress

Purpose:

Aggregate Root tiến độ học tập

Columns:

id (UUID, PK)

student_id (UUID, FK → users.id)

chapter_id (UUID, FK → chapter.id)

chapter_state (VARCHAR, NOT NULL)
Allowed values: LOCKED | IN_PROGRESS | COMPLETED

created_at (TIMESTAMP, NOT NULL)

updated_at (TIMESTAMP, NOT NULL)

Constraints:

UNIQUE(student_id, chapter_id)

chapter_state CHECK IN ('LOCKED','IN_PROGRESS','COMPLETED')

PARTIAL UNIQUE INDEX:
UNIQUE(student_id)
WHERE chapter_state = 'IN_PROGRESS'

Notes:

DB hỗ trợ invariant: 1 Chapter IN_PROGRESS / Student

4.4. practice

Purpose:

Lưu hành vi làm bài của Student

Columns:

id (UUID, PK)

chapter_progress_id (UUID, FK → chapter_progress.id)

exercise_snapshot (JSONB, NOT NULL)

student_answer (TEXT)

is_correct (BOOLEAN)

submitted_at (TIMESTAMP)

Notes:

Practice luôn thuộc ChapterProgress

Practice trigger domain events, nhưng DB không encode logic

4.5. skill_mastery

Purpose:

Persist SkillMastery Value Object

Columns:

student_id (UUID, FK → users.id)

skill_id (UUID, FK → skill.id)

mastery_value (INT, NOT NULL)

updated_at (TIMESTAMP, NOT NULL)

Primary Key:

(student_id, skill_id)

Constraints:

mastery_value BETWEEN 0 AND 100

Notes:

SkillMastery KHÔNG unlock Chapter

NHỮNG ĐIỀU TUYỆT ĐỐI CẤM

Question table

Session / MiniTest

skill_completion boolean

progress table ngoài chapter_progress

trigger / stored procedure

trial / license / payment / device

cascade delete chapter_progress

FLYWAY MIGRATION PLAN – PHASE 1

Migration phải chạy theo thứ tự:

V1__create_users_and_refresh_token.sql

users

refresh_token

V2__create_student_profile_and_parent_relation.sql

student_profile

parent_student

V3__create_chapter_and_skill.sql

chapter

skill

V4__create_exercise_content.sql

exercise

exercise_solution

exercise_tag

exercise_review_log

V5__create_chapter_progress.sql

chapter_progress

unique constraints

partial index

V6__create_practice.sql

practice

V7__create_skill_mastery.sql

skill_mastery

KẾT LUẬN CUỐI

Schema này:

Giữ trọn tài sản tri thức

Không phá Domain Model Phase 1

Không mở scope ngầm

Sẵn sàng cho Phase 2 mở rộng (Question, Session)

File này được coi là FINAL.
Mọi thay đổi sau thời điểm này:

BẮT BUỘC quay lại System Law hoặc Phase Scope.

END OF DB SCHEMA AND FLYWAY PLAN – PHASE 1 (FINAL)