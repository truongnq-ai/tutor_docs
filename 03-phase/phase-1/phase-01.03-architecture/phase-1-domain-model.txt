---

Phase 1 – Domain Model
Location: 03-phase/phase-1/phase-01.03-architecture/domain-model.md
Phase: Phase 1 – Core Personal Learning System
Status: DRAFT – To be frozen after review

---

1. Mục tiêu của Domain Model

Tài liệu này mô tả mô hình domain cốt lõi của Phase 1 cho hệ thống Gia sư Toán AI.

Mục tiêu của Domain Model:

* Xác định rõ ownership (ai sở hữu dữ liệu và trạng thái)
* Xác định rõ authority (ai có quyền hợp pháp để thay đổi trạng thái)
* Xác định rõ invariant (bất biến bắt buộc phải được bảo vệ)
* Là cầu nối giữa System Law, Phase Scope và code triển khai

Tài liệu này:

* KHÔNG định nghĩa luật mới
* KHÔNG diễn giải lại System Law
* KHÔNG mở đường cho Phase sau

Mọi hành vi trong domain bắt buộc phải tuân thủ:

* Phase 1 System Law Snapshot
* Phase 1 Law Constraints

---

2. Tổng quan Domain Phase 1

2.1. In-domain (nằm trong phạm vi Phase 1)

Các khái niệm và nghiệp vụ sau nằm trong domain của Phase 1:

* Student lifecycle (vòng đời học sinh – ở mức tối giản)
* Chapter progression (tiến độ chương học)
* Practice (bài luyện tập)
* Skill mastery (đánh giá năng lực – đơn giản)
* AI hỗ trợ sinh bài và giải thích (stateless, không có quyền quyết định)

2.2. Out-of-domain (ngoài phạm vi Phase 1)

Các nội dung sau TUYỆT ĐỐI KHÔNG thuộc domain Phase 1:

* Trial
* License
* Payment
* Device binding
* Commercial permission
* Recommendation engine
* Anti-abuse / anti-fraud
* Analytics mang tính thương mại

---

3. Các Aggregate và Ownership

---

3.1. Student (Aggregate Root)

Vai trò:
Student là Aggregate Root đại diện cho một học sinh trong hệ thống.
Student sở hữu và bảo vệ trạng thái vòng đời học tập của học sinh.

Owns:

* lifecycle_state

Authority (quyền hạn):

* CHỈ domain logic của Student được phép thay đổi lifecycle_state
* Mọi quyết định “có được học hay không” bắt buộc phải đọc từ lifecycle_state

Invariants (bất biến):

* lifecycle_state là single source of truth cho quyền học
* Không được suy luận quyền học từ dữ liệu khác, flag, AI hoặc frontend
* Mọi hành động học tập đều PHẢI kiểm tra lifecycle_state trước

Forbidden (tuyệt đối cấm):

* AI thay đổi lifecycle_state
* Admin bypass lifecycle_state
* Suy luận lifecycle từ trial hoặc license (đang dormant)
* Update lifecycle_state bằng SQL tay, migration hoặc script

---

3.2. ChapterProgress (Aggregate Root)

Vai trò:
ChapterProgress là Aggregate Root đại diện cho tiến độ học tập của một Chapter đối với một Student.
Đây là đơn vị tiến độ DUY NHẤT trong Phase 1.

Owns:

* chapter_state
* Tập các Practice thuộc Chapter đó

Trạng thái hợp lệ trong Phase 1:

* LOCKED
* IN_PROGRESS
* COMPLETED

Không được phép thêm bất kỳ trạng thái nào khác.

Authority (quyền hạn):

* ChapterProgress là owner duy nhất của chapter_state
* Chỉ ChapterProgress được phép:

  * chuyển trạng thái Chapter
  * tuyên bố Chapter COMPLETED
  * phát (emit) event CHAPTER_COMPLETED

Quy tắc chuyển trạng thái:

* LOCKED → IN_PROGRESS: khi domain cho phép bắt đầu học
* IN_PROGRESS → COMPLETED: sau practice hợp lệ và thỏa tất cả invariant

Invariants (bất biến):

* Tại một thời điểm, chỉ được có MỘT Chapter ở trạng thái IN_PROGRESS
* COMPLETED là trạng thái kết thúc (terminal), không được quay lại
* Trạng thái Chapter:

  * không phụ thuộc thời gian
  * không bị thay đổi bởi admin
  * không bị ảnh hưởng bởi AI

Forbidden (tuyệt đối cấm):

* COMPLETED → IN_PROGRESS
* COMPLETED → LOCKED
* LOCKED → COMPLETED
* Đổi trạng thái Chapter bằng tay
* Đổi trạng thái Chapter bởi AI
* Đổi trạng thái Chapter theo cron hoặc thời gian

---

3.3. Practice (Entity)

Vai trò:
Practice là Entity phụ thuộc ChapterProgress.
Practice tồn tại để ghi nhận việc luyện tập và làm trigger cho domain flow.
Practice KHÔNG phải là Aggregate Root.

Created by:

* Domain logic của ChapterProgress

Điều kiện tạo Practice:

* Student.lifecycle_state cho phép học
* ChapterProgress.chapter_state phải là IN_PROGRESS

Invariants:

* Practice không tự quyết định nghiệp vụ
* Practice không có quyền thay đổi trạng thái domain
* Practice không sở hữu tiến độ học tập

Forbidden:

* Tạo Practice độc lập, không thông qua ChapterProgress
* Tạo Practice khi Chapter chưa ở trạng thái IN_PROGRESS
* AI tự tạo Practice rồi coi là hợp lệ

---

3.4. SkillMastery (Value Object)

Vai trò:
SkillMastery là Value Object đại diện cho mức độ thành thạo của Student đối với một Skill.

Đặc điểm:

* Không có identity riêng
* Gắn với Student và Skill
* Giá trị mastery nằm trong phạm vi hợp lệ theo System Law

Invariants:

* Mastery KHÔNG phải là đơn vị tiến độ
* Mastery KHÔNG tự trigger thay đổi Chapter state
* Mastery chỉ được cập nhật thông qua practice hợp lệ

Forbidden:

* Dùng mastery để unlock Chapter
* Dùng mastery để bypass ChapterProgress
* AI quyết định mastery cuối cùng

---

4. Domain Events

---

4.1. Event: PRACTICE_SUBMITTED

Emitted by:

* ChapterProgress (sau khi Practice được submit hợp lệ)

WHEN (khi nào phát event):

* Practice submit thành công
* Chapter đang ở trạng thái IN_PROGRESS
* Student.lifecycle_state cho phép học

WHY (mục đích):

* Thông báo việc hoàn thành một practice
* Cho phép domain đánh giá điều kiện hoàn thành Chapter và tiếp tục flow

Event này KHÔNG được làm:

* Không thay đổi lifecycle_state
* Không unlock Chapter
* Không emit CHAPTER_COMPLETED trực tiếp
* Không gọi AI

---

4.2. Event: CHAPTER_COMPLETED

Emitted by:

* ChapterProgress (DUY NHẤT)

WHEN:

* Sau khi domain xác nhận tất cả invariant đã được thỏa mãn
* Không phụ thuộc thời gian, số lượng practice hay AI suggestion

WHY:

* Tuyên bố Chapter đã hoàn thành
* Cho phép hệ thống phản ứng theo cách read-only

Event này KHÔNG được làm:

* Không unlock Chapter khác trực tiếp
* Không thay đổi lifecycle_state
* Không cascade mutation
* Không gọi AI

Trong Phase 1, điều kiện hoàn thành Chapter được chốt như sau:

Chapter được coi là COMPLETED khi:

Có ít nhất MỘT Practice được submit hợp lệ (PRACTICE_SUBMITTED)

Tất cả invariant của ChapterProgress vẫn được thỏa mãn

Phase 1 KHÔNG áp dụng:

Ngưỡng số lượng practice cố định

Ngưỡng mastery phức tạp

Điều kiện dựa trên thời gian

Quyết định từ AI

Mục tiêu của Completion Rule Phase 1:

Đơn giản

Dễ test

Không mở scope

Làm nền cho Phase sau mở rộng logic completion

---

5. AI Boundary (Ranh giới AI)

Vai trò AI trong Phase 1:

* AI là pure function (hàm thuần)
* AI chỉ:

  * sinh bài tập
  * giải thích bài

AI TUYỆT ĐỐI KHÔNG được:

* Sở hữu state
* Quyết định quyền học
* Quyết định progression
* Emit domain event
* Update mastery trực tiếp

Nguyên tắc bắt buộc:
System Core luôn override AI.

AI là công cụ hỗ trợ, không phải chủ thể nghiệp vụ.

---
SECTION: Content Domain (Non-learning Aggregates)
PATCH – CONTENT DOMAIN MODEL (PHASE 1)

Content Domain bao gồm các entity đại diện cho tài sản tri thức gốc của hệ thống.
Các entity này:

Được tạo bởi Admin / AI / Giáo viên

Không gắn với Student

Không tham gia trực tiếp vào learning progression

Không emit domain event học tập

Có vòng đời dài và được tái sử dụng

Content Domain không phải Learning Domain.

Entity: Exercise

Exercise đại diện cho đề bài toán gốc.

Đặc điểm:

Là content asset

Không có lifecycle học tập

Không gắn Student

Không quyết định tiến độ

Exercise chứa:

Nội dung đề bài (text, latex)

Metadata (difficulty, chapter, skill)

Trạng thái biên tập (draft / reviewed / approved)

Exercise KHÔNG chứa lời giải.

Entity: ExerciseSolution

ExerciseSolution đại diện cho lời giải chuẩn của một Exercise.

Đặc điểm:

Thuộc về Exercise

Là tài sản tri thức

Không phải runtime result

Có thể có nhiều lời giải cho một Exercise

ExerciseSolution được sử dụng cho:

Review nội dung

Đánh giá chất lượng

(Phase sau) hiển thị lời giải cho học sinh

Entity: ExerciseTag

ExerciseTag đại diện cho metadata phân loại gắn trực tiếp vào Exercise.

Đặc điểm:

Không có bảng Tag master

Tag tồn tại trong ngữ cảnh của Exercise

Phục vụ tìm kiếm, lọc, và AI processing

ExerciseTag không tham gia learning flow.

Entity: ExerciseReviewLog

ExerciseReviewLog đại diện cho audit trail và lịch sử kiểm duyệt nội dung.

Đặc điểm:

Ghi nhận hành động review (submit, approve, reject, update)

Không ảnh hưởng đến học sinh

Không ảnh hưởng learning progression

ExerciseReviewLog chỉ phục vụ governance và quality control.

Content Domain – Explicit Boundaries

Content Domain entities:

KHÔNG được:

thay đổi ChapterProgress

tạo Practice

emit PRACTICE_SUBMITTED hoặc CHAPTER_COMPLETED

KHÔNG được dùng để unlock học tập

Learning Domain KHÔNG phụ thuộc trực tiếp vào Content Domain lifecycle.

---

6. Tổng kết

Domain Model Phase 1 đảm bảo:

* Ownership rõ ràng
* Authority không mơ hồ
* Invariant được bảo vệ đúng Aggregate
* Không tồn tại “vùng xám” cho AI, admin hoặc code tiện tay

Tài liệu này, cùng với:

* Phase 1 System Law Snapshot
* Phase 1 Law Constraints

là nguồn sự thật duy nhất cho việc triển khai code Phase 1.

END OF PHASE 1 DOMAIN MODEL

---
