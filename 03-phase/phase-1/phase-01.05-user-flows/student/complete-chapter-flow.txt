USER FLOW: STUDENT – COMPLETE CHAPTER FLOW
Phase: Phase 1
Actor: Student
Purpose: Hệ thống xác nhận hoàn thành Chapter hợp lệ và chuyển Chapter sang trạng thái COMPLETED

Preconditions (Điều kiện trước)

Student đã đăng nhập hợp lệ

Student có role = STUDENT

Student.lifecycle_state cho phép học

Student có đúng 1 ChapterProgress ở trạng thái IN_PROGRESS

ChapterProgress tồn tại hợp lệ cho Student + Chapter

Student đã thực hiện ít nhất 1 Practice hợp lệ trong Chapter này

Không tồn tại trial, license, payment, device restriction

Không có can thiệp admin hoặc AI vào trạng thái Chapter

Trigger (Hành động kích hoạt)

Trigger KHÔNG đến trực tiếp từ hành động UI của Student

Trigger đến từ domain sau khi:

một Practice được submit hợp lệ

hoặc domain đánh giá lại điều kiện hoàn thành Chapter

Lưu ý quan trọng:

Student KHÔNG có nút “Hoàn thành chương”

Completion là quyết định của domain, không phải của người dùng

Step-by-step Flow

Step 1
Sau khi PRACTICE_SUBMITTED được emit, ChapterProgressDomainLogic tiếp tục xử lý domain flow nội bộ.
PATCH: LIFECYCLE TIMING NOTE

Chapter completion chỉ được xét khi:

Student.lifecycle_state tại thời điểm PRACTICE_SUBMITTED là hợp lệ

Completion KHÔNG:

re-check lifecycle tại thời điểm emit CHAPTER_COMPLETED

override lifecycle nếu đã thay đổi sau đó

Lifecycle là điều kiện hợp lệ tại thời điểm hành động học,
không phải điều kiện hậu kiểm.

Step 2
ChapterProgressDomainLogic gọi hàm checkCompletion().

Step 3
checkCompletion() đánh giá các điều kiện hoàn thành Chapter theo Phase 1:

ChapterProgress.chapter_state phải là IN_PROGRESS

Invariant toàn cục vẫn được thỏa:

chỉ 1 Chapter IN_PROGRESS

Không dựa vào:

số lượng practice cố định

thời gian học

AI suggestion

mastery threshold phức tạp

Lưu ý:

Điều kiện hoàn thành có thể rất đơn giản trong Phase 1

Nhưng quyết định LUÔN nằm trong domain

Step 4
Nếu điều kiện hoàn thành CHƯA thỏa:

Không làm gì thêm

ChapterProgress giữ nguyên trạng thái IN_PROGRESS

Flow kết thúc tại đây

Step 5
Nếu điều kiện hoàn thành ĐÃ thỏa:

ChapterProgressDomainLogic chuẩn bị chuyển trạng thái

Step 6
ChapterProgressDomainLogic thực hiện các kiểm tra cuối cùng (final invariant check):

ChapterProgress.chapter_state == IN_PROGRESS

Không tồn tại ChapterProgress khác ở IN_PROGRESS

Không có request song song làm thay đổi state

Nếu bất kỳ invariant nào FAIL:

Reject completion

Log domain violation

Flow kết thúc

Step 7
ChapterProgressDomainLogic:

Chuyển chapter_state từ IN_PROGRESS → COMPLETED

Persist trạng thái mới

Step 8
ChapterProgressDomainLogic emit domain event CHAPTER_COMPLETED.

Domain Ownership & Authority

ChapterProgress là Aggregate Root duy nhất có quyền:

xác nhận hoàn thành Chapter

đổi chapter_state sang COMPLETED

emit CHAPTER_COMPLETED

Không có bất kỳ class, service hoặc actor nào khác được phép:

đánh dấu Chapter COMPLETED

gọi trực tiếp event này

Events

Event: CHAPTER_COMPLETED

Emitted by:

ChapterProgressDomainLogic (DUY NHẤT)

WHEN:

Sau khi trạng thái Chapter đã được persist thành COMPLETED

Sau khi toàn bộ invariant được thỏa

WHY:

Tuyên bố Chapter đã hoàn thành hợp lệ

Cho phép hệ thống phản ứng read-only (ví dụ: hiển thị tiến độ)

Event này TUYỆT ĐỐI KHÔNG được:

Unlock Chapter khác trực tiếp

Thay đổi Student.lifecycle_state

Gọi AI

Cascade mutation sang domain khác

Kích hoạt logic Phase sau

System Reaction (Read-only)

Sau khi CHAPTER_COMPLETED được emit, hệ thống CÓ THỂ (không bắt buộc):

Ghi nhận lịch sử học tập

Cập nhật view model cho Parent (read-only)

Chuẩn bị dữ liệu hiển thị tiến độ

Hệ thống KHÔNG ĐƯỢC:

Tự động mở Chapter mới

Thay đổi quyền học

Gán Chapter khác cho Student

Forbidden Paths (Đường cấm)

Flow này TUYỆT ĐỐI KHÔNG cho phép:

Student tự bấm “Complete Chapter”

Admin đánh dấu Chapter COMPLETED

AI đề xuất và hệ thống chấp nhận completion

Completion theo thời gian (cron, timeout)

Completion theo số lượng practice cứng

Completion khi Chapter chưa IN_PROGRESS

Completion khi Student lifecycle không cho phép

Postconditions (Trạng thái sau)

ChapterProgress.chapter_state = COMPLETED

Không còn ChapterProgress nào ở trạng thái IN_PROGRESS

Student.lifecycle_state giữ nguyên

Domain ở trạng thái nhất quán, sẵn sàng cho Phase 1 tiếp theo

END OF USER FLOW: STUDENT – COMPLETE CHAPTER FLOW