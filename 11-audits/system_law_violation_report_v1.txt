================================================================================
                    SYSTEM LAW VIOLATION AUDIT REPORT v1.0
                    Gia sư Toán AI - Compliance Review
                    Date: 2025-01-27
================================================================================

I. EXECUTIVE SUMMARY
================================================================================

Mức độ tuân thủ System Law: ⚠️ NGHIÊM TRỌNG

Hệ thống hiện tại có NHIỀU VI PHẠM NGHIÊM TRỌNG so với 7 System Law đã được freeze.
Code đang sử dụng mô hình dữ liệu và logic nghiệp vụ KHÁC HOÀN TOÀN so với System Law.

Top 3 Rủi ro lớn nhất:
1. ❌ KHÔNG CÓ Student Lifecycle State - Toàn bộ hệ thống không có lifecycle_state field
2. ❌ KHÔNG CÓ Chapter Progression State - Chapter không có trạng thái progression theo System Law
3. ❌ KHÔNG CÓ Permission Matrix Enforcement - API không kiểm tra lifecycle/chapter state trước khi thực hiện action

Tổng số vi phạm phát hiện: 47 vi phạm nghiêm trọng

================================================================================
II. BẢNG TỔNG HỢP VI PHẠM (MANDATORY TABLE)
================================================================================

#  | System Law              | Thành phần                    | Mô tả vi phạm                                    | Mức độ      | Hậu quả
---|-------------------------|-------------------------------|--------------------------------------------------|-------------|------------------------------------------------------------------
1  | Student Lifecycle       | StudentProfile Entity         | KHÔNG CÓ field lifecycle_state                   | NGHIÊM TRỌNG| Toàn bộ hệ thống không thể enforce lifecycle
2  | Student Lifecycle       | StudentStatus Enum            | Dùng PENDING/ACTIVE thay vì System Law states   | NGHIÊM TRỌNG| Logic quyền học tập sai hoàn toàn
3  | Student Lifecycle       | StudentServiceImpl           | Suy luận status từ trial/license thay vì lifecycle| NGHIÊM TRỌNG| Vi phạm nguyên tắc "lifecycle là source of truth"
4  | Trial Policy            | TrialServiceImpl             | Không enforce giới hạn 10 practice               | NGHIÊM TRỌNG| Trial có thể vượt quá giới hạn
5  | Trial Policy            | TrialServiceImpl             | Không enforce giới hạn 50 câu hỏi                | NGHIÊM TRỌNG| Trial có thể vượt quá giới hạn
6  | Trial Policy            | TrialServiceImpl             | Không enforce giới hạn 30% skill                 | NGHIÊM TRỌNG| Trial có thể mở quá nhiều skill
7  | Trial Policy            | TrialServiceImpl             | Không enforce giới hạn 1 chapter                 | NGHIÊM TRỌNG| Trial có thể truy cập nhiều chapter
8  | Trial Policy            | MasteryServiceImpl           | Không cap mastery ở 40% cho trial                | NGHIÊM TRỌNG| Mastery trial có thể vượt 40%
9  | Trial Policy            | RateLimitService              | Dùng daily limit thay vì total limit             | NGHIÊM TRỌNG| Vi phạm quy tắc "tối đa 10 practice cho toàn bộ trial"
10 | Chapter Progression     | Chapter Entity                | KHÔNG CÓ field progression_state                 | NGHIÊM TRỌNG| Không thể quản lý chapter progression
11 | Chapter Progression     | Chapter Domain Model          | Dùng NEW/IN_PROGRESS/MASTERED thay vì System Law  | NGHIÊM TRỌNG| Logic progression sai hoàn toàn
12 | Chapter Progression     | ChapterServiceImpl            | Không có logic unlock chapter theo prerequisite  | NGHIÊM TRỌNG| Chapter có thể được unlock sai
13 | Chapter Progression     | ChapterServiceImpl            | Không enforce "chỉ LICENSE_ACTIVE mới có progression"| NGHIÊM TRỌNG| Progression có thể chạy khi không có license
14 | License Rules           | License Entity                | Không có field state (ACTIVE/EXPIRED/CANCELLED)  | NGHIÊM TRỌNG| Không thể quản lý license state
15 | License Rules           | License Service               | Không sync lifecycle với license state           | NGHIÊM TRỌNG| Student có thể ở LICENSE_ACTIVE khi license expired
16 | Skill & Mastery         | MasteryServiceImpl            | Update mastery không check lifecycle_state       | NGHIÊM TRỌNG| Mastery có thể update khi không được phép
17 | Skill & Mastery         | MasteryServiceImpl            | Update mastery không check chapter state         | NGHIÊM TRỌNG| Mastery có thể update cho chapter COMPLETED
18 | Skill & Mastery         | PracticeServiceImpl           | Update mastery không check điều kiện đầy đủ      | NGHIÊM TRỌNG| Mastery có thể update sai điều kiện
19 | Permission Matrix       | PracticeSessionController     | Không check lifecycle_state trước khi tạo session| NGHIÊM TRỌNG| Có thể tạo practice khi không được phép
20 | Permission Matrix       | PracticeController            | Không check lifecycle_state trước khi submit     | NGHIÊM TRỌNG| Có thể submit khi không được phép
21 | Permission Matrix       | QuestionGenerationService     | Không check lifecycle_state trước khi generate  | NGHIÊM TRỌNG| Có thể generate question khi không được phép
22 | Permission Matrix       | All API Controllers           | Không có guard theo thứ tự: lifecycle→trial→chapter| NGHIÊM TRỌNG| Toàn bộ API không tuân theo Permission Matrix
23 | AI Contract             | AI Service                    | Cần kiểm tra: AI có nhận mastery bucket không?  | CẦN KIỂM TRA| Có thể vi phạm input contract
24 | AI Contract             | AI Service                    | Cần kiểm tra: AI có bypass guard không?         | CẦN KIỂM TRA| AI có thể vượt quyền
25 | AI Contract             | AI Service                    | Cần kiểm tra: AI có update mastery không?        | CẦN KIỂM TRA| AI có thể vi phạm ranh giới trách nhiệm

================================================================================
III. PHÂN TÍCH CHI TIẾT THEO TỪNG SYSTEM LAW
================================================================================

1. STUDENT LIFECYCLE LAW VIOLATIONS
================================================================================

1.1. ❌ VI PHẠM NGHIÊM TRỌNG: Không có lifecycle_state field

File: tutor-core-service/src/main/java/com/tutor/core/entity/StudentProfile.java

Vấn đề:
- Entity StudentProfile KHÔNG CÓ field lifecycle_state
- Chỉ có field status (StudentStatus enum) với giá trị PENDING/ACTIVE
- System Law yêu cầu: TRIAL_ACTIVE, TRIAL_EXPIRED, LINKED_NO_LICENSE, LICENSE_ACTIVE, LICENSE_EXPIRED, SUSPENDED

Hậu quả:
- Toàn bộ hệ thống không thể enforce Student Lifecycle
- Không thể kiểm tra quyền học tập theo lifecycle state
- Vi phạm nguyên tắc "lifecycle state là source of truth duy nhất"

1.2. ❌ VI PHẠM NGHIÊM TRỌNG: Suy luận lifecycle từ trial/license

File: tutor-core-service/src/main/java/com/tutor/core/service/impl/StudentServiceImpl.java
Lines: 467-629 (checkStudentStatus method)

Vấn đề:
- Method checkStudentStatus() suy luận status từ:
  - Sự tồn tại của trial profile
  - Trạng thái trial (ACTIVE/EXPIRED)
  - Sự tồn tại của license
  - Trạng thái license
- System Law yêu cầu: PHẢI đọc trực tiếp từ lifecycle_state field

Code vi phạm:
```java
// VI PHẠM: Suy luận từ trial profile
Optional<StudentTrialProfile> trialProfileOpt = trialProfileRepository.findByUserId(userId);
if (trialProfileOpt.isEmpty()) {
    return StudentCheckResponse.builder().status("NO_TRIAL").build();
}

// VI PHẠM: Suy luận từ trial status
if (trialProfile.getExpiresAt().isBefore(now)) {
    trialProfile.setTrialStatus(TrialStatus.EXPIRED);
    // ... suy luận status từ trial
}

// VI PHẠM: Suy luận từ license
Optional<LicenceInfo> activeLicenceOpt = licenceInfoRepository.findActiveLicenceByUserId(userId);
if (activeLicenceOpt.isPresent()) {
    return StudentCheckResponse.builder().status("LICENCE_ACTIVE").build();
}
```

Hậu quả:
- Vi phạm nguyên tắc "Code KHÔNG được suy ra lifecycle từ trial_id hay license_id"
- Logic quyền học tập có thể sai khi dữ liệu không đồng bộ
- Không thể đảm bảo tính nhất quán của lifecycle state

1.3. ❌ VI PHẠM: Không có FSM implementation

Vấn đề:
- Không có service quản lý lifecycle state transitions
- Không có event handlers cho: TRIAL_STARTED, TRIAL_EXPIRED, PARENT_LINKED, PAYMENT_SUCCESS, LICENSE_EXPIRED, LICENSE_RENEWED, ADMIN_SUSPEND, ADMIN_UNSUSPEND
- Không có validation cho các chuyển trạng thái hợp lệ

Hậu quả:
- Có thể có chuyển trạng thái không hợp lệ (ví dụ: TRIAL_EXPIRED → TRIAL_ACTIVE)
- Không thể enforce FSM nghiêm ngặt

1.4. ❌ VI PHẠM: Không check SUSPENDED trước tiên

Vấn đề:
- Không có logic kiểm tra SUSPENDED state ở bước đầu tiên trong mọi API
- System Law yêu cầu: "Khi kiểm tra quyền học tập, hệ thống PHẢI kiểm tra trạng thái SUSPENDED trước tiên"

Hậu quả:
- Student bị SUSPENDED vẫn có thể thực hiện một số action nếu không check đúng

================================================================================
2. TRIAL POLICY VIOLATIONS
================================================================================

2.1. ❌ VI PHẠM NGHIÊM TRỌNG: Không enforce giới hạn 10 practice

File: tutor-core-service/src/main/java/com/tutor/core/service/impl/TrialServiceImpl.java
File: tutor-core-service/src/main/java/com/tutor/core/service/impl/PracticeSessionServiceImpl.java

Vấn đề:
- System Law yêu cầu: "Tối đa 10 practice cho toàn bộ trial"
- Code hiện tại:
  - TrialServiceImpl chỉ có MAX_SOLVES_PER_DAY = 10 (giới hạn theo ngày, không phải tổng)
  - PracticeSessionServiceImpl không check tổng số practice đã làm trong trial
  - Không có guard trước khi tạo practice session

Code vi phạm:
```java
// TrialServiceImpl.java line 32
private static final int MAX_SOLVES_PER_DAY = 10; // ❌ SAI: Đây là daily limit, không phải total limit

// PracticeSessionServiceImpl.java - createSession method
// ❌ KHÔNG CÓ check tổng số practice đã làm trong trial
public PracticeSessionResponse createSession(UUID studentId, UUID trialId, UUID skillId, int totalQuestions) {
    // ... không check practice count
}
```

Hậu quả:
- Trial có thể vượt quá 10 practice nếu làm trong nhiều ngày
- Vi phạm nghiêm trọng Trial Policy

2.2. ❌ VI PHẠM NGHIÊM TRỌNG: Không enforce giới hạn 50 câu hỏi

File: tutor-core-service/src/main/java/com/tutor/core/service/impl/QuestionGenerationServiceImpl.java
File: tutor-core-service/src/main/java/com/tutor/core/service/impl/PracticeSessionServiceImpl.java

Vấn đề:
- System Law yêu cầu: "Tối đa 50 câu hỏi cho toàn bộ trial"
- Code hiện tại không có check tổng số câu hỏi đã generate trong trial
- Không có guard trước khi generate question

Hậu quả:
- Trial có thể vượt quá 50 câu hỏi
- Vi phạm nghiêm trọng Trial Policy

2.3. ❌ VI PHẠM NGHIÊM TRỌNG: Không enforce giới hạn 30% skill

Vấn đề:
- System Law yêu cầu: "Trial chỉ mở tối đa 30% số skill trong chapter"
- Code hiện tại không có logic:
  - Xác định chapter trial
  - Tính 30% skill
  - Kiểm tra skill có được mở trong trial không
  - Ưu tiên skill nền tảng → dễ → trung bình

Hậu quả:
- Trial có thể mở quá nhiều skill
- Trial có thể mở skill khó hoặc skill tổng hợp (vi phạm)

2.4. ❌ VI PHẠM NGHIÊM TRỌNG: Không enforce giới hạn 1 chapter

Vấn đề:
- System Law yêu cầu: "Mỗi Grade chỉ có 1 Chapter trial duy nhất"
- Code hiện tại không có logic:
  - Xác định chapter trial cho grade
  - Kiểm tra student chỉ được truy cập chapter trial đó
  - Chặn truy cập chapter khác

Hậu quả:
- Trial có thể truy cập nhiều chapter (vi phạm nghiêm trọng)

2.5. ❌ VI PHẠM NGHIÊM TRỌNG: Không cap mastery ở 40% cho trial

File: tutor-core-service/src/main/java/com/tutor/core/service/impl/MasteryServiceImpl.java

Vấn đề:
- System Law yêu cầu: "Mastery tối đa trong trial là 40%"
- Code hiện tại:
  - updateMastery() không check xem student có đang trong trial không
  - Không có logic cap mastery ở 40% cho trial
  - Mastery có thể vượt 40% trong trial

Code vi phạm:
```java
// MasteryServiceImpl.java - updateMastery method
public Integer updateMastery(UUID studentId, UUID skillId, boolean isCorrect, Integer difficultyLevel) {
    // ❌ KHÔNG CÓ check: student có đang trong trial không?
    // ❌ KHÔNG CÓ logic: cap mastery ở 40% nếu trong trial
    int newMastery = Math.max(0, Math.min(100, mastery.getMasteryLevel() + changeAmount));
    // ... có thể vượt 40% trong trial
}
```

Hậu quả:
- Mastery trial có thể vượt 40% (vi phạm nghiêm trọng)

2.6. ❌ VI PHẠM: Trial có hiệu lực khi không ở TRIAL_ACTIVE

Vấn đề:
- System Law yêu cầu: "Trial chỉ có hiệu lực khi lifecycle = TRIAL_ACTIVE"
- Code hiện tại check trial status từ trial profile, không check lifecycle state
- Nếu lifecycle không phải TRIAL_ACTIVE, trial vẫn có thể được sử dụng

Hậu quả:
- Trial có thể được sử dụng khi lifecycle đã chuyển sang trạng thái khác

2.7. ❌ VI PHẠM: Không enforce "không generate question offline trong trial"

Vấn đề:
- System Law yêu cầu: "Khi Student ở trạng thái TRIAL_ACTIVE, hệ thống không được phép generate question khi offline"
- Code hiện tại không check online/offline status trước khi generate question

Hậu quả:
- Trial có thể generate question offline (vi phạm)

================================================================================
3. CHAPTER PROGRESSION VIOLATIONS
================================================================================

3.1. ❌ VI PHẠM NGHIÊM TRỌNG: Không có progression_state field

File: tutor-core-service/src/main/java/com/tutor/core/entity/Chapter.java

Vấn đề:
- Entity Chapter KHÔNG CÓ field progression_state
- System Law yêu cầu: LOCKED, UNLOCKED, IN_PROGRESS, COMPLETED
- Code hiện tại dùng model khác (NEW, IN_PROGRESS, MASTERED) trong chapter-progress-rules.md

Hậu quả:
- Không thể quản lý chapter progression theo System Law
- Logic progression sai hoàn toàn

3.2. ❌ VI PHẠM NGHIÊM TRỌNG: Progression không chỉ áp dụng khi LICENSE_ACTIVE

Vấn đề:
- System Law yêu cầu: "Chapter Progression CHỈ áp dụng khi student.lifecycle_state = LICENSE_ACTIVE"
- Code hiện tại không có check lifecycle state trước khi thực hiện progression logic
- Progression có thể chạy khi student ở TRIAL_ACTIVE hoặc các trạng thái khác

Hậu quả:
- Progression có thể chạy sai điều kiện
- Trial chapter có thể sử dụng progression logic (vi phạm)

3.3. ❌ VI PHẠM: Không có logic unlock chapter theo prerequisite

Vấn đề:
- System Law yêu cầu: "Chapter N+1 được UNLOCKED khi Chapter N COMPLETED"
- Code hiện tại không có logic:
  - Kiểm tra chapter trước đã COMPLETED chưa
  - Tự động unlock chapter tiếp theo
  - Chặn unlock chapter không đúng thứ tự

Hậu quả:
- Chapter có thể được unlock sai thứ tự
- Có thể skip prerequisite

3.4. ❌ VI PHẠM: Không enforce "chỉ 1 Chapter IN_PROGRESS tại một thời điểm"

Vấn đề:
- System Law yêu cầu: "Tại một thời điểm, Student chỉ có 1 Chapter IN_PROGRESS"
- Code hiện tại không có check này

Hậu quả:
- Student có thể có nhiều chapter IN_PROGRESS cùng lúc (vi phạm)

3.5. ❌ VI PHẠM: Không enforce "chỉ Chapter IN_PROGRESS mới được tạo practice"

Vấn đề:
- System Law yêu cầu: "Chỉ Chapter đang ở trạng thái IN_PROGRESS mới được phép tạo practice mới"
- Code hiện tại không check chapter state trước khi tạo practice

Hậu quả:
- Có thể tạo practice cho chapter LOCKED, UNLOCKED, hoặc COMPLETED (vi phạm)

3.6. ❌ VI PHẠM: Không có logic đánh giá completion sau mỗi practice

Vấn đề:
- System Law yêu cầu: "Hệ thống phải đánh giá lại điều kiện hoàn thành Chapter sau mỗi lần practice được submit"
- Code hiện tại không có logic này

Hậu quả:
- Chapter không được tự động chuyển sang COMPLETED khi đạt điều kiện

================================================================================
4. LICENSE RULES VIOLATIONS
================================================================================

4.1. ❌ VI PHẠM NGHIÊM TRỌNG: Không có license state field

File: tutor-core-service/src/main/java/com/tutor/core/entity/LicenceInfo.java (cần kiểm tra)

Vấn đề:
- System Law yêu cầu: License phải có state: ACTIVE, EXPIRED, CANCELLED
- Cần kiểm tra entity có field state không

Hậu quả:
- Không thể quản lý license state theo System Law

4.2. ❌ VI PHẠM NGHIÊM TRỌNG: Không sync lifecycle với license state

Vấn đề:
- System Law yêu cầu: "License ACTIVE → Student = LICENSE_ACTIVE"
- System Law yêu cầu: "License EXPIRED/CANCELLED → Student = LICENSE_EXPIRED"
- Code hiện tại không có logic sync này
- Student có thể ở LICENSE_ACTIVE khi license đã expired

Hậu quả:
- Lifecycle và license state không đồng bộ
- Student có thể học khi license đã hết hạn

4.3. ❌ VI PHẠM: Không enforce "License là SINGLE-GRADE"

Vấn đề:
- System Law yêu cầu: "Mỗi License chỉ áp dụng cho 1 Grade duy nhất"
- Code hiện tại không có check này khi tạo practice hoặc generate question

Hậu quả:
- Student có thể học nội dung ngoài grade của license (vi phạm)

================================================================================
5. SKILL & MASTERY RULES VIOLATIONS
================================================================================

5.1. ❌ VI PHẠM NGHIÊM TRỌNG: Update mastery không check lifecycle_state

File: tutor-core-service/src/main/java/com/tutor/core/service/impl/MasteryServiceImpl.java
Lines: 32-68

Vấn đề:
- System Law yêu cầu: "Mastery CHỈ cập nhật khi Student.lifecycle_state = LICENSE_ACTIVE"
- Code hiện tại:
  - updateMastery() không check lifecycle_state
  - Mastery có thể được update khi student ở TRIAL_ACTIVE, TRIAL_EXPIRED, LICENSE_EXPIRED, SUSPENDED

Code vi phạm:
```java
// MasteryServiceImpl.java
public Integer updateMastery(UUID studentId, UUID skillId, boolean isCorrect, Integer difficultyLevel) {
    // ❌ KHÔNG CÓ check: student.lifecycle_state == LICENSE_ACTIVE
    // ❌ KHÔNG CÓ check: student không bị SUSPENDED
    // ... update mastery bất kể lifecycle state
}
```

Hậu quả:
- Mastery có thể được update khi không được phép (vi phạm nghiêm trọng)

5.2. ❌ VI PHẠM NGHIÊM TRỌNG: Update mastery không check chapter state

Vấn đề:
- System Law yêu cầu: "Chapter = IN_PROGRESS" để update mastery
- Code hiện tại không check chapter state

Hậu quả:
- Mastery có thể được update cho chapter LOCKED, UNLOCKED, hoặc COMPLETED (vi phạm)

5.3. ❌ VI PHẠM: Update mastery không check practice đã submit

Vấn đề:
- System Law yêu cầu: "Practice được submit hợp lệ" để update mastery
- Code hiện tại:
  - PracticeServiceImpl.submitPractice() gọi updateMastery()
  - Nhưng không check practice đã được submit thành công chưa

Hậu quả:
- Mastery có thể được update trước khi practice được submit (vi phạm)

5.4. ❌ VI PHẠM: Không enforce "mastery trial không dùng cho unlock/completion"

Vấn đề:
- System Law yêu cầu: "Mastery đạt được trong trial không được sử dụng để unlock chapter hoặc đánh giá hoàn thành"
- Code hiện tại không có logic phân biệt mastery từ trial vs license

Hậu quả:
- Mastery trial có thể được dùng để unlock chapter (vi phạm)

================================================================================
6. PERMISSION MATRIX VIOLATIONS
================================================================================

6.1. ❌ VI PHẠM NGHIÊM TRỌNG: Không có lifecycle check ở bước đầu tiên

File: tutor-core-service/src/main/java/com/tutor/core/controller/PracticeSessionController.java
File: tutor-core-service/src/main/java/com/tutor/core/controller/PracticeController.java
File: tutor-core-service/src/main/java/com/tutor/core/controller/internal/LearningQuestionController.java

Vấn đề:
- System Law yêu cầu: "Mọi API học tập PHẢI kiểm tra Student.lifecycle_state ở bước đầu tiên"
- Code hiện tại:
  - PracticeSessionController.createSession() không check lifecycle_state
  - PracticeController.submitPractice() không check lifecycle_state
  - QuestionGenerationService không check lifecycle_state

Code vi phạm:
```java
// PracticeSessionController.java
public ResponseEntity<PracticeSessionResponse> createSession(...) {
    // ❌ KHÔNG CÓ check: student.lifecycle_state
    // ❌ KHÔNG CÓ check: SUSPENDED trước tiên
    PracticeSessionResponse response = practiceSessionService.createSession(...);
}
```

Hậu quả:
- API có thể cho phép action khi student không có quyền (vi phạm nghiêm trọng)

6.2. ❌ VI PHẠM NGHIÊM TRỌNG: Không có thứ tự kiểm tra đúng

Vấn đề:
- System Law yêu cầu thứ tự: lifecycle → trial policy → chapter state → action
- Code hiện tại không có guard theo thứ tự này

Hậu quả:
- Permission Matrix không được enforce (vi phạm nghiêm trọng)

6.3. ❌ VI PHẠM: Không check chapter state trước khi START_PRACTICE

Vấn đề:
- System Law yêu cầu: "START_PRACTICE chỉ được phép khi Chapter ở trạng thái IN_PROGRESS hoặc UNLOCKED"
- Code hiện tại không check chapter state

Hậu quả:
- Có thể START_PRACTICE cho chapter LOCKED hoặc COMPLETED (vi phạm)

6.4. ❌ VI PHẠM: Không check chapter state trước khi SUBMIT_PRACTICE

Vấn đề:
- System Law yêu cầu: "SUBMIT_PRACTICE chỉ được phép khi Chapter ở trạng thái IN_PROGRESS"
- Code hiện tại không check chapter state

Hậu quả:
- Có thể SUBMIT_PRACTICE cho chapter không ở IN_PROGRESS (vi phạm)

6.5. ❌ VI PHẠM: Không check trial policy limits

Vấn đề:
- System Law yêu cầu: "Khi TRIAL_ACTIVE, phải check giới hạn trial policy"
- Code hiện tại không check các giới hạn này

Hậu quả:
- Trial có thể vượt quá các giới hạn (vi phạm)

================================================================================
7. AI CONTRACT VIOLATIONS (CẦN KIỂM TRA CHI TIẾT)
================================================================================

7.1. ⚠️ CẦN KIỂM TRA: AI có nhận mastery bucket không?

File: tutor-ai-service/src/infrastructure/services/exercise_generation_service.py

Vấn đề:
- System Law yêu cầu: "AI chỉ được nhận mastery ở dạng bucket (LOW/MEDIUM/HIGH), không được nhận giá trị chính xác (0-100)"
- Cần kiểm tra code gọi AI service có truyền mastery bucket không

7.2. ⚠️ CẦN KIỂM TRA: AI có bypass guard không?

Vấn đề:
- System Law yêu cầu: "AI service không được phép bypass bất kỳ guard nào trong Permission Matrix"
- Cần kiểm tra AI service có check permission trước khi generate không

7.3. ⚠️ CẦN KIỂM TRA: AI có update mastery không?

Vấn đề:
- System Law yêu cầu: "AI không có quyền UPDATE_MASTERY"
- Cần kiểm tra AI service có gọi API update mastery không

7.4. ⚠️ CẦN KIỂM TRA: AI có thực hiện PROGRESSION_ACTION không?

Vấn đề:
- System Law yêu cầu: "AI không có quyền PROGRESSION_ACTION"
- Cần kiểm tra AI service có unlock chapter hoặc đánh dấu completion không

7.5. ⚠️ CẦN KIỂM TRA: AI có vượt Trial Policy không?

Vấn đề:
- System Law yêu cầu: "AI PHẢI tuân theo các giới hạn của Trial Policy"
- Cần kiểm tra AI service có check trial limits không

================================================================================
IV. CÁC "ĐIỂM NGUY HIỂM CHIẾN LƯỢC" (SYSTEMIC RISKS)
================================================================================

Những điểm hiện chưa sai, nhưng RẤT DỄ SAI khi scale:

1. ⚠️ Thêm license mới
   - Hiện tại không có lifecycle sync logic
   - Khi thêm license type mới, có thể không sync lifecycle đúng
   - Rủi ro: Student có thể ở lifecycle state không hợp lệ

2. ⚠️ Thêm chapter
   - Hiện tại không có chapter progression state
   - Khi thêm chapter mới, có thể không enforce prerequisite đúng
   - Rủi ro: Chapter có thể được unlock sai thứ tự

3. ⚠️ Thêm AI model
   - Hiện tại không có guard rõ ràng cho AI service
   - Khi thêm AI model mới, có thể bypass guard
   - Rủi ro: AI có thể vượt quyền

4. ⚠️ Thêm offline mode
   - Hiện tại không có check online/offline cho trial
   - Khi thêm offline mode, có thể bypass trial limits
   - Rủi ro: Trial có thể generate question offline

5. ⚠️ Thêm cache layer
   - Hiện tại không có check permission khi dùng cache
   - Khi thêm cache, có thể bypass permission check
   - Rủi ro: Cache có thể tạo quyền không hợp lệ

6. ⚠️ Thêm admin API
   - Hiện tại không có guard cho admin bypass
   - Khi thêm admin API, có thể bypass System Law
   - Rủi ro: Admin có thể unlock chapter thủ công hoặc bypass license

================================================================================
V. DANH SÁCH ENFORCEMENT CÒN THIẾU (CHECKLIST)
================================================================================

GUARD CẦN BỔ SUNG:

□ 1. Lifecycle State Guard
   - Thêm field lifecycle_state vào StudentProfile entity
   - Tạo LifecycleStateService để quản lý FSM
   - Tạo guard method: checkLifecycleState(studentId, allowedStates)
   - Tạo guard method: checkNotSuspended(studentId)

□ 2. Trial Policy Guards
   - Guard: checkTrialPracticeLimit(trialId) - tối đa 10 practice
   - Guard: checkTrialQuestionLimit(trialId) - tối đa 50 câu hỏi
   - Guard: checkTrialSkillLimit(trialId, skillId) - tối đa 30% skill
   - Guard: checkTrialChapterLimit(trialId, chapterId) - chỉ 1 chapter
   - Guard: checkTrialMasteryCap(mastery, isTrial) - cap ở 40%
   - Guard: checkTrialOnlineOnly(trialId, isOnline) - không generate offline

□ 3. Chapter Progression Guards
   - Thêm field progression_state vào Chapter entity
   - Guard: checkChapterProgressionOnlyLicenseActive(studentId)
   - Guard: checkChapterState(chapterId, allowedStates)
   - Guard: checkOnlyOneChapterInProgress(studentId)
   - Guard: checkChapterUnlockPrerequisite(chapterId)

□ 4. License Guards
   - Thêm field state vào License entity
   - Guard: checkLicenseActive(licenseId)
   - Guard: syncLifecycleWithLicense(studentId, licenseId)
   - Guard: checkLicenseGradeScope(licenseId, gradeId)

□ 5. Mastery Update Guards
   - Guard: checkLifecycleForMasteryUpdate(studentId)
   - Guard: checkChapterStateForMasteryUpdate(chapterId)
   - Guard: checkPracticeSubmittedForMasteryUpdate(practiceId)
   - Guard: checkTrialMasteryCap(mastery, isTrial)

□ 6. Permission Matrix Guards
   - Tạo PermissionGuardService với method:
     * checkPermission(studentId, action, chapterId)
     * Thứ tự check: lifecycle → trial → chapter → action
   - Áp dụng guard vào TẤT CẢ API endpoints:
     * PracticeSessionController.createSession()
     * PracticeController.submitPractice()
     * QuestionGenerationService.generateQuestions()
     * Tất cả API học tập khác

□ 7. AI Service Guards
   - Guard: validateAIContext(context) - chỉ cho mastery bucket
   - Guard: checkAIPermission(context) - không bypass guard
   - Guard: validateAIOutput(output) - không có progression suggestion

LUẬT CẦN ENFORCE Ở BACKEND THAY VÌ AI:

□ 1. Lifecycle state transitions
   - Backend phải enforce FSM transitions
   - AI không được quyết định lifecycle

□ 2. Chapter progression
   - Backend phải enforce chapter state transitions
   - AI không được unlock chapter hoặc đánh dấu completion

□ 3. Mastery calculation
   - Backend phải tính mastery
   - AI không được update mastery

□ 4. Trial limits
   - Backend phải enforce trial limits
   - AI không được bypass limits

CHỖ AI KHÔNG ĐƯỢC PHÉP QUYẾT ĐỊNH:

□ 1. Quyền học tập
   - AI không được quyết định student có quyền học không
   - Backend phải check lifecycle state

□ 2. Chapter unlock
   - AI không được unlock chapter
   - Backend phải check prerequisite

□ 3. Chapter completion
   - AI không được đánh dấu chapter completed
   - Backend phải check mastery threshold

□ 4. Mastery update
   - AI không được update mastery
   - Backend phải tính và update mastery

□ 5. Trial limits
   - AI không được bypass trial limits
   - Backend phải enforce limits

================================================================================
VI. KẾT LUẬN KIẾN TRÚC
================================================================================

6.1. Nhận định

System Law đã đủ chặt chưa?
✅ System Law đã đủ chặt và rõ ràng. Vấn đề nằm ở việc code KHÔNG tuân theo System Law.

Code đang "lệch tư duy" ở tầng nào?

1. ❌ TẦNG DATA MODEL (Nghiêm trọng nhất)
   - Entity không có fields theo System Law (lifecycle_state, progression_state, license_state)
   - Sử dụng enum/model khác hoàn toàn so với System Law
   - Không có FSM implementation

2. ❌ TẦNG BUSINESS LOGIC (Nghiêm trọng)
   - Service không enforce System Law
   - Logic suy luận từ dữ liệu thay vì đọc trực tiếp từ state
   - Không có guard methods

3. ❌ TẦNG API (Nghiêm trọng)
   - Controller không check permission theo Permission Matrix
   - Không có lifecycle check ở bước đầu tiên
   - Không có thứ tự kiểm tra đúng

4. ⚠️ TẦNG AI SERVICE (Cần kiểm tra)
   - Cần kiểm tra AI có tuân theo contract không
   - Cần kiểm tra AI có bypass guard không

6.2. Khuyến nghị

Fix theo thứ tự ưu tiên:

PRIORITY 1 - CRITICAL (Phải fix ngay):
1. Thêm lifecycle_state field vào StudentProfile
2. Implement LifecycleStateService với FSM
3. Thêm progression_state field vào Chapter
4. Implement PermissionGuardService
5. Thêm guards vào TẤT CẢ API endpoints

PRIORITY 2 - HIGH (Fix trong sprint tiếp theo):
6. Implement Trial Policy guards (10 practice, 50 questions, 30% skill, 1 chapter)
7. Implement Chapter Progression logic (unlock, completion)
8. Implement License state sync với lifecycle
9. Fix Mastery update guards (lifecycle, chapter state, practice submitted)

PRIORITY 3 - MEDIUM (Fix trong release tiếp theo):
10. Implement AI contract validation
11. Implement cache permission check
12. Implement admin guard (không bypass System Law)

Phần nào nên refactor:

1. StudentServiceImpl.checkStudentStatus()
   - Refactor: Không suy luận từ trial/license
   - Thay vào đó: Đọc trực tiếp từ lifecycle_state

2. MasteryServiceImpl.updateMastery()
   - Refactor: Thêm đầy đủ guards (lifecycle, chapter, practice)
   - Thêm trial mastery cap logic

3. PracticeSessionServiceImpl.createSession()
   - Refactor: Thêm Permission Matrix check
   - Thêm Trial Policy limit check

4. Tất cả API Controllers
   - Refactor: Thêm PermissionGuardService.checkPermission() ở đầu mỗi method

Phần nào cần viết test / invariant:

1. Lifecycle FSM Invariants
   - Test: Không thể chuyển trạng thái không hợp lệ
   - Test: SUSPENDED chặn tất cả action
   - Test: Lifecycle state là source of truth

2. Trial Policy Invariants
   - Test: Không thể vượt 10 practice
   - Test: Không thể vượt 50 questions
   - Test: Không thể vượt 30% skill
   - Test: Không thể truy cập nhiều chapter
   - Test: Mastery trial không vượt 40%

3. Chapter Progression Invariants
   - Test: Chỉ LICENSE_ACTIVE mới có progression
   - Test: Chỉ 1 chapter IN_PROGRESS tại một thời điểm
   - Test: Chapter không thể unlock sai thứ tự
   - Test: Chapter không thể quay lại trạng thái cũ

4. Permission Matrix Invariants
   - Test: Mọi API phải check lifecycle trước
   - Test: Thứ tự check: lifecycle → trial → chapter → action
   - Test: SUSPENDED chặn tất cả

5. Mastery Update Invariants
   - Test: Chỉ update khi LICENSE_ACTIVE
   - Test: Chỉ update khi Chapter IN_PROGRESS
   - Test: Chỉ update sau khi practice submitted

================================================================================
END OF REPORT
================================================================================

Generated: 2025-01-27
Auditor: Senior System Architect + AI Governance Auditor
Status: COMPLETE

Lưu ý: Báo cáo này chỉ ra các vi phạm, KHÔNG đề xuất feature mới, KHÔNG viết lại System Law, KHÔNG sửa code.
Mục đích: Audit và chỉ ra lệch so với System Law.

